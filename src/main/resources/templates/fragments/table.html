<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"/></head>
<body>

<!-- 사용: th:replace="~{fragments/table :: dataTableCard('dataTable', '가격 목록', ${null})}" -->
<th:block th:fragment="dataTableCard(tableId, title, rows)">
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary" th:text="${title}">가격 목록</h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered" th:attr="id=${tableId}" width="100%" cellspacing="0">
          <thead>
            <tr>
              <th>상품이름</th>
              <th>상품가격</th>
              <th>1+1여부</th>
              <th>할인날짜</th>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <th>상품이름</th>
              <th>상품가격</th>
              <th>1+1여부</th>
              <th>할인날짜</th>
            </tr>
          </tfoot>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DataTables 초기화 (마커 클릭 시만 로드) -->
  <script th:inline="javascript">
    (function () {
      var _id = /*[[${tableId}]]*/ 'dataTable';
      var table = null;
      var state = { entpId: null }; // 외부(마커 클릭)에서 주입

      function initTable() {
        if (window.jQuery && $.fn && $.fn.DataTable && $.fn.DataTable.isDataTable('#' + _id)) {
          table = $('#' + _id).DataTable();
          return;
        }

        table = $('#' + _id).DataTable({
          ajax: function(_req, cb){
            if (!state.entpId) { cb({ data: [] }); return; }
            $.ajax({
              url: '/api/table/KcaPriceInfoByEntpId',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ entpId: state.entpId }),
              success: function(rows){ cb({ data: rows || [] }); },
              error: function(){ cb({ data: [] }); }
            });
          },
          // 서버 DTO: { good_name, good_price, plusone_yn, date }
          // 헤더 순서에 맞게 컬럼 매핑
          columns: [
            { data: 'good_name' },               // 상품이름
            { data: 'good_price',                // 상품가격(3자리 콤마)
              render: function(d){
                if (d == null) return '';
                var n = String(d).replace(/[^0-9.-]/g,'');
                if (n === '' || isNaN(Number(n))) return d;
                return n.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
              }
            },
            { data: 'plusone_yn',                // 1+1여부 (null -> 공란)
              render: function(v){ return v == null ? '' : v; }
            },
            { data: 'date' }                     // 할인날짜: "-" 또는 "MM월DD일 ~ MM월DD일"
          ],
          pageLength: 10,
          lengthChange: false,
          ordering: true,
          searching: true,
          deferRender: true
        });
      }

      // 초기엔 테이블만 준비(데이터는 로드 안 함)
      document.addEventListener('DOMContentLoaded', function(){ initTable(); });

      // 외부에서 호출(마커 클릭 시)
      window.loadEntpTable = function(entp){
        state.entpId = (entp || '').toString().trim();
        if (!state.entpId) { if (table) table.clear().draw(); return; }
        if (!table) initTable();
        table.ajax.reload(null, false);
      };
    })();
  </script>
</th:block>

</body>
</html>
