<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"/></head>
<body>

<th:block th:fragment="kakaoMap">
  <div id="map" style="width:100%;max-width:980px;height:500px;"></div>

  <!-- Kakao Maps SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e48a3eae8e588f8eccfd76324172ae11&autoload=false"></script>
  <script>
    (function(){
      var map;
      var markers = [];
      var infoWindows = [];
    
      function ensureMap(){
        if (map) return map;
        var el = document.getElementById('map');
        if (!el) return null;
        map = new kakao.maps.Map(el, {
          center: new kakao.maps.LatLng(37.5665, 126.9780),
          level: 7
        });
        return map;
      }
    
      function clearMarkers(){
        infoWindows.forEach(function(iw){ try{ iw.close(); }catch(e){} });
        infoWindows = [];
        markers.forEach(function(m){ m.setMap(null); });
        markers = [];
      }
    
      // 대한민국 대략 범위 체크
      function isValidKorea(lat, lng){
        return lat >= 33 && lat <= 39 && lng >= 124 && lng <= 132;
      }
    
      // ⬇️ x/y가 서로 바뀌어 들어오는 걸 행별로 교정
      function toLatLng(xStr, yStr){
        var x = parseFloat(xStr);
        var y = parseFloat(yStr);
        if (!isFinite(x) || !isFinite(y)) return null;
    
        // 경도는 90보다 큼(한국은 ~126~129)
        // 1) x>90 ⇒ x=경도, y=위도
        // 2) y>90 ⇒ y=경도, x=위도
        var lat, lng;
        if (x > 90 && y <= 90) { lat = y; lng = x; }
        else if (y > 90 && x <= 90) { lat = x; lng = y; }
        else {
          // 둘 다 <=90 같은 비정상 케이스는 일단 x=lat, y=lng로 가정
          lat = x; lng = y;
        }
    
        if (!isValidKorea(lat, lng)) return null;
        return { lat: lat, lng: lng };
      }
    
      function renderMarkers(items){
        var m = ensureMap();
        if (!m) return;
    
        m.relayout();          // 컨테이너 변경 보정
        clearMarkers();
    
        var bounds = new kakao.maps.LatLngBounds();
        var any = false;
    
        (items || []).forEach(function(item){
          var coord = toLatLng(item.x_map_coord, item.y_map_coord);
          if (!coord) return;
    
          var pos = new kakao.maps.LatLng(coord.lat, coord.lng);
          var marker = new kakao.maps.Marker({ position: pos });
          marker.setMap(m);
          markers.push(marker);
          bounds.extend(pos);
          any = true;
    
          var html =
            '<div style="padding:6px 8px;max-width:240px;">'
              + '<div style="font-weight:700;margin-bottom:4px;">' + (item.entp_name || '-') + '</div>'
              + '<div style="font-size:12px;color:#555;">'
                + (item.plmk_addr_basic || '-') + (item.plmk_addr_detail ? (' ' + item.plmk_addr_detail) : '')
              + '</div>'
              + '<div style="margin-top:6px;text-align:right;">'
                + '<button type="button" id="btn-'+ item.entp_id +'" style="padding:4px 8px;">가격 불러오기</button>'
              + '</div>'
            + '</div>';
    
          var iw = new kakao.maps.InfoWindow({ content: html });
          infoWindows.push(iw);
    
          kakao.maps.event.addListener(marker, 'click', function(){
            infoWindows.forEach(function(other){ try{ other.close(); }catch(e){} });
            iw.open(m, marker);
    
            // 상세 패널/테이블 호출 (당신 기존 로직 유지)
            document.dispatchEvent(new CustomEvent('kca:store:selected', {
              detail: {
                entpId: item.entp_id,
                entpName: item.entp_name,
                entpTelno: item.entp_telno,
                plmkAddrBasic: item.plmk_addr_basic,
                plmkAddrDetail: item.plmk_addr_detail
              },
              bubbles: true
            }));
            if (window.loadEntpTable) window.loadEntpTable(item.entp_id);
    
            setTimeout(function(){
              var btn = document.getElementById('btn-'+ item.entp_id);
              if (btn) btn.onclick = function(){
                if (window.loadEntpTable) window.loadEntpTable(item.entp_id);
              };
            }, 0);
          });
        });
    
        if (any){
          setTimeout(function(){
            m.relayout();
            m.setBounds(bounds);
          }, 0);
        }
      }
    
      function loadStores(upper, lower){
        return fetch('/api/table/map', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ upper: upper, lower: lower })
        })
        .then(function(res){ if (!res.ok) throw new Error('HTTP ' + res.status); return res.json(); })
        .then(function(rows){ renderMarkers(rows || []); })
        .catch(function(err){
          console.error(err);
          alert('매장 데이터 조회 실패');
        });
      }
    
      kakao.maps.load(function(){ ensureMap(); });
    
      document.addEventListener('region:selected', function(e){
        var upper = e.detail && e.detail.upper || '';
        var lower = e.detail && e.detail.lower || '';
        if (!upper || !lower) return;
        loadStores(upper, lower);
      });
    })();
    </script>
    
</th:block>

</body>
</html>
