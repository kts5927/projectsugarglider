<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"/></head>
<body>

<!-- regionPicker(upperList, lowersByUpper, selectedUpper, selectedLower, buttonText) -->
<div th:fragment="regionPicker(upperList, lowersByUpper, selectedUpper, selectedLower, buttonText)">

  <div class="form-inline mb-3" id="regionPicker">
    <select id="upperCodeInput" class="form-control mr-2" style="width:160px;">
      <option value="">상위지역 선택</option>
      <option th:each="u : ${upperList}"
              th:value="${u.code}"
              th:text="${u.name}"
              th:selected="${u.code} == ${selectedUpper}">
      </option>
    </select>

    <select id="lowerCodeInput" class="form-control mr-2" style="width:160px;">
      <option value="">하위지역 선택</option>
    </select>

    <button id="loadRegionBtn" type="button" class="btn btn-primary"
            th:text="${buttonText} != null ? ${buttonText} : '지역 불러오기'">지역 불러오기</button>

    <input id="selectedRegionCode" type="hidden" th:value="${selectedLower}">
  </div>

  <script th:inline="javascript">
    (function(){
      var lowersByUpper = /*[[${lowersByUpper}]]*/ {};
      var selectedUpper = /*[[${selectedUpper}]]*/ '';
      var selectedLower = /*[[${selectedLower}]]*/ '';

      function fillLower(upper, keepSelected) {
        var lower = document.getElementById('lowerCodeInput');
        lower.innerHTML = '<option value="">하위지역 선택</option>';
        var list = lowersByUpper[upper] || [];
        list.forEach(function (item) {
          var opt = document.createElement('option');
          opt.value = item.code;
          opt.textContent = item.name;
          lower.appendChild(opt);
        });
        if (keepSelected && selectedLower) {
          lower.value = selectedLower;
        }
      }

      document.addEventListener('DOMContentLoaded', function(){
        var upper  = document.getElementById('upperCodeInput');
        var lower  = document.getElementById('lowerCodeInput');
        var btn    = document.getElementById('loadRegionBtn');
        var hidden = document.getElementById('selectedRegionCode');

        if (upper.value) fillLower(upper.value, true);

        upper.addEventListener('change', function(){
          selectedLower = '';
          fillLower(this.value, false);
          hidden.value = '';
        });

        btn.addEventListener('click', function(){
          hidden.value = lower.value || '';
          var detail = {
            upper: upper.value,
            lower: lower.value,
            upperName: upper.options[upper.selectedIndex]?.text || '',
            lowerName: lower.options[lower.selectedIndex]?.text || ''
          };
          btn.dispatchEvent(new CustomEvent('region:selected', { detail: detail, bubbles: true }));
        });
      });

    })();
  </script>
</div>

</body>
</html>
